<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Furniture App - Smart Interior Design</title>
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
</head>
<body>
    <!-- Header -->
    <header>
        <a href="home.html" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 6px; font-weight: 500;">
            ‚Üê Back to Home
        </a>
        <h1>üè† AR Furniture App</h1>
        <div style="width: 100px;"></div>
    </header>
    <!-- Main Container -->
    <div class="container">
        <!-- Chat Section -->
        <section class="section">
            <h2>üí¨ AI Design Assistant</h2>
    <div id="chatbox"></div>
            <div class="chat-input-container">
                <input type="text" id="userInput" placeholder="Ask me about furniture, upload a room photo, or request recommendations..." onkeypress="handleKeyPress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">
                    <span>Send</span>
                </button>
    </div>
        </section>
        <!-- Furniture Inventory -->
        <section id="inventory-container" class="section" style="display: none;">
            <h2>üõãÔ∏è Our Furniture Collection</h2>
        <div id="inventory-items"></div>
        </section>
        <!-- Image Upload Section -->
        <section id="image-upload-section" class="section">
            <h2>üì∏ Upload Your Room</h2>
            <p class="text-center mb-6" style="color: var(--gray-600); font-size: var(--font-size-lg);">
                Upload a photo of your room to get personalized furniture recommendations
            </p>
        <div id="canvas-container">
            <canvas id="main-canvas"></canvas>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="loadImageToCanvas(event)">
                <div id="toolbar" style="display: none;">
                    <button onclick="enableBrushTool()" title="Draw mask with brush">
                        üñåÔ∏è Brush
                    </button>
                    <button onclick="enableRectangleSelection()" title="Select rectangular area">
                        ‚¨õ Rectangle
                    </button>
                    <button onclick="enableEraser()" title="Erase parts of mask">
                        ü©π Eraser
                    </button>
                    <button onclick="undoLastAction()" title="Undo last action">
                        ‚Ü©Ô∏è Undo
                    </button>
                    <button onclick="confirmMask()" title="Confirm and process mask">
                        ‚úÖ Confirm
                    </button>
                    <button onclick="clearMask()" title="Clear all masks">
                        ‚ùå Clear
                    </button>
                </div>
            </div>
            <div class="text-center mt-4">
                <p style="color: var(--gray-500); font-size: var(--font-size-sm);">
                    Click on the canvas area to upload an image, then use the tools to mark the furniture area you want to replace
                </p>
            </div>
        </section>
        <!-- Suggested Furniture Section -->
        <section id="suggested-furniture-section" class="section">
            <h2>‚ú® Recommended Furniture</h2>
            <div class="furniture-preview">
                <div>
                    <img id="suggestedFurnitureImage" src="" alt="Suggested Furniture" class="furniture-image">
                </div>
                <div class="furniture-info">
                    <h3 id="suggestedFurnitureName"></h3>
                    <div class="price" id="suggestedFurniturePrice"></div>
                    <div class="description" id="suggestedFurnitureScore" style="margin-top:6px;color:var(--gray-600);"></div>
                    <div class="description" id="suggestedFurnitureDescription"></div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="handleUserResponse('yes')">
                            üëç Yes, I like it!
                        </button>
                        <button class="btn btn-outline" onclick="handleUserResponse('no')">
                            üëé Show me another
                        </button>
            </div>
        </div>
    </div>
        </section>
        <!-- Segmented Image Section -->
        <section id="segmented-image-section" class="section">
            <h2>üéØ Segmented Area</h2>
            <div class="text-center">
                <img id="segmentedImage" src="" alt="Segmented Image" class="furniture-image">
                <p class="mt-4" style="color: var(--gray-600);">
                    The red area shows where the furniture will be placed
                </p>
        </div>
        </section>
        <!-- Inpainted Image Section -->
        <section id="inpainted-image-section" class="section">
            <h2>üé® Room with New Furniture</h2>
            <div class="text-center">
                <img id="inpaintedImage" src="" alt="Inpainted Image" class="furniture-image">
    </div>
            <!-- Controls -->
            <div id="controls">
                <h3 style="text-align: center; margin-bottom: var(--spacing-6); color: var(--gray-800);">
                    üéõÔ∏è Adjust Your Furniture
                </h3>
                <div class="control-group">
                    <label for="opacity">Opacity:</label>
                    <input type="range" id="opacity" min="0" max="1" step="0.1" value="1" oninput="updateOpacity()">
                    <span id="opacityValue">100%</span>
    </div>
                <div class="control-buttons">
                    <button onclick="resizeSofa(1.1)" title="Make larger">
                        üîç Enlarge
                    </button>
                    <button onclick="resizeSofa(0.9)" title="Make smaller">
                        üîç Shrink
                    </button>
            </div>
        </div>
        </section>
        <!-- AR Viewer Section -->
        <section id="ar-viewer" class="section">
            <h2>üì± View in AR</h2>
            <p class="text-center mb-6" style="color: var(--gray-600); font-size: var(--font-size-lg);">
                Experience your furniture in augmented reality
            </p>
        <model-viewer
            id="ar-model"
            src=""
            ar
            ar-modes="scene-viewer"
            camera-controls
            auto-rotate
            shadow-intensity="1"
            environment-image="neutral"
            exposure="1.5"
            style="width: 100%; height: 500px; border-radius: var(--radius-xl);">
            <div class="loading" slot="poster"></div>
        </model-viewer>
            <div class="text-center mt-6">
                <button class="btn btn-primary" onclick="showQRCode()">
                    üì± Generate QR Code for Mobile AR
                </button>
            </div>
        </section>
    </div>
    <!-- QR Code Modal -->
    <div id="qr-modal">
        <div id="qr-container">
            <h3>üì± Scan with Your Phone (Android)</h3>
            <div style="background: var(--gray-100); padding: var(--spacing-4); border-radius: var(--radius-lg); margin-bottom: var(--spacing-4);">
                <p style="color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: var(--spacing-2);">
                    <strong>üì± For Android:</strong> Open your camera app and point it at the QR code
                </p>
                        <p style="color: var(--gray-600); font-size: var(--font-size-xs);">
                            üí° Make sure your phone is on the same Wi-Fi network as this computer
                        </p>
                        <div style="background: white; padding: var(--spacing-3); border-radius: var(--radius-md); margin: var(--spacing-3) 0;">
                            <p style="color: var(--gray-700); font-size: var(--font-size-sm); margin-bottom: var(--spacing-2);">
                                <strong>üîó Alternative:</strong> Open this link directly on your phone:
                            </p>
                            <div id="direct-ar-link" style="word-break: break-all; color: var(--primary-color); font-size: var(--font-size-xs);">
                                Loading...
                            </div>
                        </div>
            </div>
            <div id="qr-code"></div>
            <button class="btn btn-primary" id="close-qr" onclick="closeQRCode()" style="margin-top: var(--spacing-4);">
                Close
            </button>
        </div>
    </div>
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; padding: var(--spacing-8); border-radius: var(--radius-xl); text-align: center;">
            <div class="loading" style="margin: 0 auto var(--spacing-4);"></div>
            <p style="color: var(--gray-700); font-weight: 500;">Processing your request...</p>
        </div>
    </div>
    <!-- JavaScript -->
    <script>
        // Configuration
        const host = window.location.hostname || '127.0.0.1';
        const backendUrl = `http://${host}:8000`;
        // Global variables
        let fabricCanvas;
        let selectedFurniture = "";
        let sortedSofas = [];
        let sofaDetails = {};
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        async function initializeApp() {
            // Initialize chatbot
            addChatbotMessage("üëã Hello! I'm your AI interior design assistant. I can help you find the perfect furniture for your space!");
            addChatbotMessage("üí° Try asking me about furniture styles, upload a room photo for recommendations, or say 'show inventory' to see what we have available.");
            // Load initial furniture data
            await loadInitialFurnitureData();
            // Set up canvas click handler
            document.getElementById("main-canvas").addEventListener("click", function() {
                document.getElementById("imageUpload").click();
            });
            // Set up opacity slider
            const opacitySlider = document.getElementById("opacity");
            const opacityValue = document.getElementById("opacityValue");
            opacitySlider.addEventListener('input', function() {
                opacityValue.textContent = Math.round(this.value * 100) + '%';
            });
        }
        // Load initial furniture data
        async function loadInitialFurnitureData() {
            try {
                showLoading(true);
                const response = await fetch(`${backendUrl}/get-initial-furniture`);
                if (!response.ok) throw new Error('Failed to load furniture data');
                const data = await response.json();
                window.sofaDetails = data.sofa_details;
                console.log("Initial furniture data loaded:", window.sofaDetails);
                // Don't auto-display inventory - only show when user requests it
            } catch (error) {
                console.error("Error loading initial furniture data:", error);
                addChatbotMessage("‚ö†Ô∏è Sorry, I couldn't load the furniture inventory. Please try again later.");
            } finally {
                showLoading(false);
            }
        }
        // Show/hide loading overlay
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }
        // Load image to canvas
        async function loadImageToCanvas(event) {
            const file = event.target.files[0];
            if (!file) return;
            showLoading(true);
            addChatbotMessage("üì∏ Processing your room image...");
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imgObj = new Image();
                imgObj.src = e.target.result;
                imgObj.onload = function() {
                    initializeCanvas(imgObj);
                };
                let formData = new FormData();
                formData.append("file", file);
                try {
                    const response = await fetch(`${backendUrl}/upload/`, {
                        method: "POST",
                        body: formData,
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const result = await response.json();
                    console.log("Backend Response:", result);
                    window.sortedSofas = result.sorted_sofas;
                    window.sofaDetails = result.sofa_details;
                    if (result.suggested_furniture) {
                        displaySuggestedFurniture(result.suggested_furniture);
                        addChatbotMessage(`üéØ Perfect! I found a great match: ${result.suggested_furniture.name}`);
                        addChatbotMessage(`üí° ${result.suggested_furniture.reason}`);
                        addChatbotMessage("‚ùì Do you like this recommendation? Click 'Yes' to proceed or 'No' to see alternatives.");
                    } else {
                        addChatbotMessage("üòî I couldn't find a suitable furniture match. Please try uploading a different room image.");
                    }
                } catch (error) {
                    console.error("Upload failed:", error);
                    addChatbotMessage("‚ùå Image upload failed. Please try again with a different image.");
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsDataURL(file);
        }
        // Display suggested furniture
        function displaySuggestedFurniture(furniture) {
            document.getElementById("suggestedFurnitureName").textContent = furniture.name;
            document.getElementById("suggestedFurnitureImage").src = furniture.thumbnail;
            document.getElementById("suggestedFurniturePrice").textContent = `$${furniture.price}`;
            if (typeof furniture.similarity_score !== 'undefined') {
                const pct = Math.round(Math.max(0, Math.min(1, furniture.similarity_score)) * 100);
                document.getElementById("suggestedFurnitureScore").textContent = `Match score: ${pct}%`;
            } else if (furniture.score !== undefined) {
                // from cosine recommender results
                const pct = Math.round(Math.max(0, Math.min(1, furniture.score)) * 100);
                document.getElementById("suggestedFurnitureScore").textContent = `Match score: ${pct}%`;
            } else {
                document.getElementById("suggestedFurnitureScore").textContent = "";
            }
            document.getElementById("suggestedFurnitureDescription").textContent = furniture.description;
            document.getElementById("suggested-furniture-section").style.display = 'block';
        }
        // Initialize Fabric.js canvas
        function initializeCanvas(imageObj) {
            const canvasElement = document.getElementById("main-canvas");
            if (!fabricCanvas) {
                fabricCanvas = new fabric.Canvas("main-canvas", {
                    isDrawingMode: false,
                    backgroundColor: "white",
                });
            } else {
                fabricCanvas.clear();
            }
            let maxCanvasWidth = 800;
            let maxCanvasHeight = 600;
            fabricCanvas.setWidth(maxCanvasWidth);
            fabricCanvas.setHeight(maxCanvasHeight);
            let scaleFactor = Math.min(
                maxCanvasWidth / imageObj.width,
                maxCanvasHeight / imageObj.height
            );
            let scaledWidth = imageObj.width * scaleFactor;
            let scaledHeight = imageObj.height * scaleFactor;
            const fabricImage = new fabric.Image(imageObj, {
                left: (maxCanvasWidth - scaledWidth) / 2,
                top: (maxCanvasHeight - scaledHeight) / 2,
                scaleX: scaleFactor,
                scaleY: scaleFactor,
                selectable: false,
                evented: false,
            });
            fabricCanvas.add(fabricImage);
            fabricCanvas.renderAll();
            document.getElementById("toolbar").style.display = "flex";
            addChatbotMessage("‚úÖ Image loaded! Use the tools above to mark the furniture area you want to replace.");
        }
        // Canvas tools
        function enableBrushTool() {
            if (!fabricCanvas) return;
            fabricCanvas.isDrawingMode = true;
            fabricCanvas.freeDrawingBrush.width = 10;
            fabricCanvas.freeDrawingBrush.color = "red";
            updateToolbarActive('brush');
        }
        function enableRectangleSelection() {
            if (!fabricCanvas) return;
            fabricCanvas.isDrawingMode = false;
            let rect, isDrawing = false;
            fabricCanvas.on('mouse:down', function(o) {
                const pointer = fabricCanvas.getPointer(o.e);
                isDrawing = true;
                rect = new fabric.Rect({
                    left: pointer.x,
                    top: pointer.y,
                    width: 0,
                    height: 0,
                    fill: "rgba(255, 0, 0, 0.5)",
                    stroke: "red",
                    strokeWidth: 2,
                    selectable: false,
                });
                fabricCanvas.add(rect);
            });
            fabricCanvas.on('mouse:move', function(o) {
                if (!isDrawing || !rect) return;
                const pointer = fabricCanvas.getPointer(o.e);
                rect.set({
                    width: pointer.x - rect.left,
                    height: pointer.y - rect.top,
                });
                fabricCanvas.renderAll();
            });
            fabricCanvas.on('mouse:up', function() {
                isDrawing = false;
            });
            updateToolbarActive('rectangle');
        }
        function enableEraser() {
            if (!fabricCanvas) return;
            fabricCanvas.isDrawingMode = true;
            fabricCanvas.freeDrawingBrush.width = 20;
            fabricCanvas.freeDrawingBrush.color = "white";
            updateToolbarActive('eraser');
        }
        function clearMask() {
            if (fabricCanvas) {
                const backgroundImage = fabricCanvas.getObjects().find(obj => obj.type === "image");
                fabricCanvas.clear();
                if (backgroundImage) {
                    fabricCanvas.add(backgroundImage);
                }
            }
            addChatbotMessage("üßπ Mask cleared! You can now draw a new selection.");
        }
        function updateToolbarActive(tool) {
            // Remove active class from all buttons
            document.querySelectorAll('#toolbar button').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to current tool (if needed)
        }
        // Handle user response
        function handleUserResponse(response) {
            if (response === "yes") {
                if (window.currentMask) {
                    addChatbotMessage("üé® Great choice! Now applying the furniture to your room...");
                    inpaintImage();
                } else {
                    addChatbotMessage("üé® Great choice! Now please draw a mask over the furniture area you want to replace and click 'Confirm'.");
                    enableRectangleSelection();
                }
            } else {
                getNextBestFurniture();
            }
        }
        // Get next best furniture
        function getNextBestFurniture() {
            if (window.sortedSofas && window.sortedSofas.length > 0) {
                // rotate the list so we cycle through all items endlessly
                const first = window.sortedSofas.shift();
                window.sortedSofas.push(first);
                const nextFurniture = window.sortedSofas[0][0];
                const nextScore = window.sortedSofas[0][1];
                const sofaName = nextFurniture.replace(".png", "");
                const sofaInfo = window.sofaDetails[sofaName];
                displaySuggestedFurniture({
                    name: sofaName,
                    thumbnail: `http://${host}:8000/thumbnails/${nextFurniture}`,
                    price: sofaInfo.price,
                    description: sofaInfo.description,
                    score: typeof nextScore === 'number' ? nextScore : undefined
                });
                  addChatbotMessage(`üîÑ How about this one: ${sofaName}?`);
                addChatbotMessage("‚ùì Do you like this alternative?");
            } else {
                addChatbotMessage("üòî That's all the furniture options I have for now. Please try uploading a different room image for more suggestions.");
            }
        }
        // Confirm mask and segment
        async function confirmMask() {
            const maskDataURL = fabricCanvas.toDataURL("image/png");
            addChatbotMessage("üîç Processing segmentation...");
            showLoading(true);
            try {
                const response = await fetch(`${backendUrl}/segment/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ mask_base64: maskDataURL })
                });
                const result = await response.json();
                if (result.mask) {
                    addChatbotMessage("‚úÖ Segmentation successful!");
                    document.getElementById("segmentedImage").src = `data:image/png;base64,${result.segmented_image}`;
                    document.getElementById("segmented-image-section").style.display = 'block';
                    // Store the mask for later use in inpainting
                    window.currentMask = result.mask;
                    addChatbotMessage("üéØ Perfect! The segmented area is ready. Now click 'Yes' on the furniture recommendation to apply it to your room!");
                } else {
                    addChatbotMessage("‚ùå Segmentation failed. Please try drawing the mask again.");
                }
            } catch (error) {
                console.error("Error during segmentation:", error);
                addChatbotMessage("‚ùå Segmentation error. Please try again.");
            } finally {
                showLoading(false);
            }
        }
        // Inpaint image
        async function inpaintImage() {
            if (!window.sortedSofas || window.sortedSofas.length === 0) {
                addChatbotMessage("‚ùå No furniture suggestion found. Please try again.");
                return;
            }
            showLoading(true);
            let suggestedFurniture = window.sortedSofas[0][0].replace(".png", "");
            let formData = new FormData();
            formData.append("suggested_furniture", suggestedFurniture);
            try {
                const response = await fetch(`${backendUrl}/inpainting-image`, {
                    method: "POST",
                    body: formData,
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (data.image) {
                    document.getElementById("inpaintedImage").src = `data:image/png;base64,${data.image}`;
                    document.getElementById("inpainted-image-section").style.display = 'block';
                    addChatbotMessage("üéâ Perfect! Your room has been updated with the new furniture!");
                    // Set up AR viewer
                    const arModel = document.getElementById("ar-model");
                    arModel.src = `http://${host}:8000/furniture/${suggestedFurniture}.glb`;
                    document.getElementById("ar-viewer").style.display = 'block';
                    addChatbotMessage("üì± You can now view the furniture in AR using the 3D viewer below!");
                } else {
                    addChatbotMessage("‚ùå Furniture placement failed. Please try again.");
                }
            } catch (error) {
                console.error("Error during inpainting:", error);
                addChatbotMessage("‚ùå Something went wrong. Please try again.");
            } finally {
                showLoading(false);
            }
        }
        // Function to get local IP address
        async function getLocalIP() {
            return new Promise((resolve) => {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                pc.onicecandidate = (ice) => {
                    if (ice && ice.candidate && ice.candidate.candidate) {
                        // Only match IPv4 addresses (avoid IPv6 for URL compatibility)
                        const ipMatch = ice.candidate.candidate.match(/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/);
                        if (ipMatch) {
                            const ip = ipMatch[1];
                            if (ip.startsWith('192.168.') || ip.startsWith('10.') || ip.startsWith('172.')) {
                                pc.close();
                                resolve(ip);
                            }
                        }
                    }
                };
                setTimeout(() => resolve('127.0.0.1'), 3000); // fallback
            });
        }
        // Show QR code for AR
        async function showQRCode() {
            const modelViewer = document.querySelector('model-viewer');
            if (!modelViewer || !modelViewer.src) {
                addChatbotMessage("‚ùå No furniture selected for AR viewing.");
                return;
            }
            // Show modal immediately
            document.getElementById('qr-modal').style.display = 'flex';
            const qrCodeElement = document.getElementById('qr-code');
            qrCodeElement.innerHTML = '<div class="loading" style="margin: 0 auto;"></div>';
            // Use the correct IP address for mobile access
            const localIP = '192.168.0.7'; // Fixed IP address
            let fileUrl = modelViewer.src;
            // Replace any localhost/127.0.0.1 with the actual IP address
            if (fileUrl.includes('127.0.0.1') || fileUrl.includes('localhost')) {
                fileUrl = fileUrl.replace(/127\.0\.0\.1|localhost/g, localIP);
            }
            console.log("Using IP for QR:", localIP);
            console.log("File URL for QR:", fileUrl);
            console.log("QRCode library available:", typeof QRCode !== 'undefined');
            // Create AR viewer URL instead of direct GLB URL
            const modelName = fileUrl.split('/').pop().replace('.glb', '');
            const arViewerUrl = `http://${localIP}:3000/ar-viewer.html?model=${modelName}`;
            // Update the direct link display
            document.getElementById('direct-ar-link').innerHTML = `
                <a href="${arViewerUrl}" target="_blank" style="color: var(--primary-color);">
                    ${arViewerUrl}
                </a>
            `;
            // Use Google Scene Viewer for direct AR access
            const modelUrl = encodeURIComponent(fileUrl);
            const intentUrl = `https://arvr.google.com/scene-viewer/1.0?file=${modelUrl}&mode=ar_only`;
            console.log("QR Code URL:", intentUrl);
            console.log("Generating QR for URL:", intentUrl);
            // Try multiple QR code generation methods
            try {
                // Method 1: Try toCanvas
                QRCode.toCanvas(qrCodeElement, intentUrl, { 
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M'
                }, function(error) {
                    if (error) {
                        console.error("Canvas QR generation failed:", error);
                        // Method 2: Try toDataURL
                        QRCode.toDataURL(intentUrl, { 
                            width: 200,
                            margin: 2,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            },
                            errorCorrectionLevel: 'M'
                        }, function(err, url) {
                            if (err) {
                                console.error("DataURL QR generation failed:", err);
                                // Method 3: Fallback to image URL
                                qrCodeElement.innerHTML = `
                                    <div style="text-align: center; color: var(--danger-color); padding: 20px;">
                                        <p>‚ùå QR code generation failed</p>
                                        <p style="font-size: 0.9em; margin-top: 10px;">
                                            Try scanning this URL with your phone's camera:<br>
                                            <a href="${intentUrl}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${intentUrl}</a>
                                        </p>
                                        <p style="font-size: 0.9em; margin-top: 10px;">
                                            Or open this link directly on your phone:<br>
                                            <a href="${arViewerUrl}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${arViewerUrl}</a>
                                        </p>
                                        <p style="font-size: 0.9em; margin-top: 10px;">
                                            <strong>Alternative:</strong> Use an online QR generator:<br>
                                            <a href="https://www.qr-code-generator.com/" target="_blank" style="color: var(--primary-color);">QR Code Generator</a>
                                        </p>
                                    </div>
                                `;
                            } else {
                                console.log("DataURL QR generated successfully");
                                qrCodeElement.innerHTML = `<img src="${url}" alt="QR Code" style="max-width: 200px; height: auto;">`;
                            }
                        });
                    } else {
                        console.log("Canvas QR code generated successfully");
                    }
                });
            } catch (e) {
                console.error("QR generation exception:", e);
                qrCodeElement.innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 20px;">
                        <p>‚ùå QR code library error</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            Try scanning this URL with your phone's camera:<br>
                            <a href="${intentUrl}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${intentUrl}</a>
                        </p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            Or open this link directly on your phone:<br>
                            <a href="${arViewerUrl}" target="_blank" style="color: var(--primary-color); word-break: break-all;">${arViewerUrl}</a>
                        </p>
                    </div>
                `;
            }
        }
        // Close QR code modal
        function closeQRCode() {
            document.getElementById('qr-modal').style.display = 'none';
        }
        // Send message to chatbot
        async function sendMessage() {
            const userInput = document.getElementById("userInput");
            const message = userInput.value.trim();
            if (!message) return;
              // Display user message
              addChatbotMessage(`You: ${message}`);
            userInput.value = "";
            try {
                showLoading(true);
                const response = await fetch(`${backendUrl}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                  const result = await response.json();
                  addChatbotMessage(`Assistant: ${result.message}`);
                // Handle inventory display with fallback
                if (result.inventory && result.inventory.length > 0) {
                    displayFurnitureInventory(result.inventory);
                    document.getElementById("inventory-container").style.display = 'block';
                } else if (window.sofaDetails && Object.keys(window.sofaDetails).length > 0) {
                    const inventory = Object.keys(window.sofaDetails).map(key => ({
                        name: window.sofaDetails[key].name,
                        thumbnail: `http://${host}:8000/thumbnails/${key}.png`,
                        price: window.sofaDetails[key].price,
                        description: window.sofaDetails[key].description
                    }));
                    displayFurnitureInventory(inventory);
                    document.getElementById("inventory-container").style.display = 'block';
                }
                // Show upload section for furniture-related queries
                const furnitureKeywords = ['sofa', 'chair', 'table', 'furniture', 'couch', 'bed', 'desk', 'room', 'upload', 'photo'];
                const isFurnitureRequest = furnitureKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword) || 
                    result.message.toLowerCase().includes(keyword)
                );
                if (isFurnitureRequest) {
                    document.getElementById("image-upload-section").style.display = 'block';
                    setTimeout(() => {
                        addChatbotMessage("üì∏ Upload a photo of your room to get personalized recommendations!");
                    }, 500);
                }
            } catch (error) {
                console.error("Error sending message:", error);
                addChatbotMessage("‚ùå Sorry, something went wrong. Please try again.");
            } finally {
                showLoading(false);
            }
        }
        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }
        // Display furniture inventory
        function displayFurnitureInventory(inventory) {
            const inventoryContainer = document.getElementById("inventory-items");
            inventoryContainer.innerHTML = "";
            if (!inventory || inventory.length === 0) {
                inventoryContainer.innerHTML = "<p style='text-align: center; color: var(--gray-500);'>No furniture items available at the moment.</p>";
                return;
            }
            inventory.forEach(item => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "furniture-item";
                const img = document.createElement("img");
                img.src = item.thumbnail;
                img.alt = item.name;
                img.className = "thumbnail";
                const name = document.createElement("div");
                name.className = "furniture-name";
                name.textContent = item.name;
                const price = document.createElement("div");
                price.className = "furniture-price";
                price.textContent = `$${item.price}`;
                const desc = document.createElement("div");
                desc.className = "furniture-desc";
                desc.textContent = item.description;
                desc.style.display = "none";
                img.onclick = () => {
                    selectedFurniture = item.name;
                      addChatbotMessage(`‚úÖ You selected: ${item.name}`);
                      addChatbotMessage(`üí∞ ${item.name} costs $${item.price}. ${item.description}`);
                    desc.style.display = desc.style.display === "none" ? "block" : "none";
                };
                itemDiv.appendChild(img);
                itemDiv.appendChild(name);
                itemDiv.appendChild(price);
                itemDiv.appendChild(desc);
                inventoryContainer.appendChild(itemDiv);
            });
        }
        // Add chatbot message
        function addChatbotMessage(message) {
            const chatbox = document.getElementById("chatbox");
            const newMessage = document.createElement("p");
            newMessage.innerHTML = message;
            chatbox.appendChild(newMessage);
            chatbox.scrollTop = chatbox.scrollHeight;
        }
        // Image manipulation functions
        function updateOpacity() {
            const opacity = document.getElementById("opacity").value;
            document.getElementById("inpaintedImage").style.opacity = opacity;
        }
        function moveSofa(x, y) {
            const inpaintedImage = document.getElementById("inpaintedImage");
            const currentLeft = parseFloat(inpaintedImage.style.left) || 0;
            const currentTop = parseFloat(inpaintedImage.style.top) || 0;
            inpaintedImage.style.left = `${currentLeft + x}px`;
            inpaintedImage.style.top = `${currentTop + y}px`;
        }
        function resizeSofa(scale) {
            const inpaintedImage = document.getElementById("inpaintedImage");
            const currentWidth = parseFloat(inpaintedImage.style.width) || inpaintedImage.width;
            const currentHeight = parseFloat(inpaintedImage.style.height) || inpaintedImage.height;
            inpaintedImage.style.width = `${currentWidth * scale}px`;
            inpaintedImage.style.height = `${currentHeight * scale}px`;
        }
        // Undo last action (placeholder)
        function undoLastAction() {
            if (fabricCanvas) {
                fabricCanvas.undo();
            }
        }
        // Quick action: Show Inventory button
        (function injectShowInventoryButton() {
            const invSection = document.getElementById('inventory-container');
            const header = invSection.querySelector('h2');
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline';
            btn.style.marginLeft = '12px';
            btn.textContent = 'Show Inventory';
            btn.onclick = async () => {
                // Try to fetch fresh inventory
                try {
                    const res = await fetch(`${backendUrl}/get-initial-furniture`);
                    if (res.ok) {
                        const data = await res.json();
                        const items = (data && Array.isArray(data.inventory) && data.inventory.length)
                          ? data.inventory
                          : Object.keys(window.sofaDetails || {}).map(key => ({
                                name: window.sofaDetails[key].name,
                                thumbnail: `http://${host}:8000/thumbnails/${key}.png`,
                                price: window.sofaDetails[key].price,
                                description: window.sofaDetails[key].description
                            }));
                        displayFurnitureInventory(items);
                        invSection.style.display = 'block';
                    }
                } catch (_) {
                    // fallback to local sofaDetails
                    const items = Object.keys(window.sofaDetails || {}).map(key => ({
                        name: window.sofaDetails[key].name,
                        thumbnail: `http://${host}:8000/thumbnails/${key}.png`,
                        price: window.sofaDetails[key].price,
                        description: window.sofaDetails[key].description
                    }));
                    displayFurnitureInventory(items);
                    invSection.style.display = 'block';
                }
            };
            header.appendChild(btn);
        })();
    </script>
</body>
</html>
